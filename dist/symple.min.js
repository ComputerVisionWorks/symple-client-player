Symple.Client=Symple.Dispatcher.extend({init:function(a){this.options=$.extend({url:a.url?a.url:"http://localhost:4000",secure:!a.url||0!=a.url.indexOf("https")&&0!=a.url.indexOf("wss")?!1:!0,token:void 0},a),this._super(),this.peer=a.peer||{},this.roster=new Symple.Roster(this),this.socket=null},connect:function(){if(Symple.log("Symple Client: Connecting: ",this.options),self=this,this.socket)throw"The client socket is not null";this.socket=io.connect(this.options.url,this.options),this.socket.on("connect",function(){Symple.log("Symple Client: Connected"),self.socket.emit("announce",{token:self.options.token||"",group:self.peer.group||"",user:self.peer.user||"",name:self.peer.name||"",type:self.peer.type||""},function(a){return Symple.log("Symple Client: Announced: ",a),200!=a.status?void self.setError("auth",a):(self.peer=$.extend(self.peer,a.data),self.roster.add(a.data),self.sendPresence({probe:!0}),self.doDispatch("announce",a),void self.socket.on("message",function(a){if("object"==typeof a){switch(a.type){case"message":a=new Symple.Message(a);break;case"command":a=new Symple.Command(a);break;case"event":a=new Symple.Event(a);break;case"presence":a=new Symple.Presence(a),a.data.online?self.roster.update(a.data):self.roster.remove(a.data.id),a.probe&&self.sendPresence(new Symple.Presence({to:a.from}));break;default:o=a,o.type=o.type||"message"}if("string"!=typeof a.from)return void Symple.log("Symple Client: Invalid sender address: ",a);var b=self.roster.get(a.from);b?a.from=b:Symple.log("Symple Client: Got message from unknown peer: ",a),self.doDispatch(a.type,a)}}))})}),this.socket.on("error",function(){self.doDispatch("connect")}),this.socket.on("connecting",function(){Symple.log("Symple Client: Connecting"),self.doDispatch("connecting")}),this.socket.on("reconnecting",function(){Symple.log("Symple Client: Reconnecting"),self.doDispatch("reconnecting")}),this.socket.on("connect_failed",function(){Symple.log("Symple Client: Connect failed"),self.doDispatch("connect_failed"),self.setError("connect")}),this.socket.on("disconnect",function(){Symple.log("Symple Client: Disconnect"),self.peer.online=!1,self.doDispatch("disconnect")})},online:function(){return this.peer.online},getPeers:function(a){self=this,this.socket.emit("peers",function(b){if(Symple.log("Peers: ",b),"object"!=typeof b)for(var c in b)self.roster.update(c);a&&a(b)})},send:function(a){if(!this.online())throw"Cannot send messages when offline";if("object"!=typeof a)throw"Message must be an object";if("string"!=typeof a.type&&(a.type="message"),a.id||(a.id=Symple.randomString(8)),a.to&&"object"==typeof a.to&&(a.to.group||a.to.user||a.to.id)&&(a.to=Symple.buildAddress(a.to,this.peer.group)),a.to&&"string"!=typeof a.to)throw"Message 'to' attribute must be an address string";if(a.to&&-1!=a.to.indexOf(this.peer.id))throw"Message sender cannot match the recipient";a.from=Symple.buildAddress(this.peer),Symple.log("Symple Client: Sending: ",a),this.socket.json.send(a)},respond:function(a){a.to=a.from,this.send(a)},sendMessage:function(a){this.send(a)},sendPresence:function(a){if(a=a||{},!this.online())throw"Cannot send message while offline";a.data=a.data?Symple.merge(this.peer,a.data):this.peer,Symple.log("Symple Client: Sending Presence: ",a),this.send(new Symple.Presence(a))},sendCommand:function(a,b,c){var d=this;a=new Symple.Command(a),this.send(a),b&&this.onResponse("command",{id:a.id},b,function(a){(c||202!=a.status&&406!=a.status)&&d.clear("command",b)})},addCapability:function(a,b){var c=this.peer;c&&("undefined"==typeof b&&(b=!0),"undefined"==typeof c.capabilities&&(c.capabilities={}),c.capabilities[a]=b)},removeCapability:function(a){var b=this.peer;b&&"undefined"!=typeof b.capabilities&&"undefined"!=typeof b.capabilities[a]&&(delete b.capabilities[key],this.sendPresence())},hasCapability:function(a,b){var c=this.roster.get(a);if(c){if("undefined"!=typeof c.capabilities&&"undefined"!=typeof c.capabilities[b])return c.capabilities[b]!==!1;if("undefined"!=typeof c.data&&"undefined"!=typeof c.data.capabilities&&"undefined"!=typeof c.data.capabilities[b])return c.data.capabilities[b]!==!1}return!1},getCapability:function(a,b){var c=this.roster.get(a);if(c){if("undefined"!=typeof c.capabilities&&"undefined"!=typeof c.capabilities[b])return c.capabilities[b];if("undefined"!=typeof c.data&&"undefined"!=typeof c.data.capabilities&&"undefined"!=typeof c.data.capabilities[b])return c.data.capabilities[b]}return void 0},setError:function(a,b){Symple.log("Symple Client: Client error: ",a,b),this.doDispatch("error",a,b),this.socket&&this.socket.disconnect()},onResponse:function(a,b,c,d){"undefined"==typeof this.listeners[a]&&(this.listeners[a]=[]),"undefined"!=typeof c&&c.constructor==Function&&this.listeners[a].push({fn:c,after:d,filters:b})},clear:function(a,b){if(Symple.log("Symple Client: Clearing callback: ",a),"undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c].fn===b&&String(this.listeners[a][c].fn)==String(b)&&(this.listeners[a].splice(c,1),Symple.log("Symple Client: Clearing callback: OK: ",a))},doDispatch:function(){this.dispatchResponse.apply(this,arguments)||this.dispatch.apply(this,arguments)},dispatchResponse:function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)if("object"==typeof this.listeners[a][c]&&"undefined"!=this.listeners[a][c].filters&&Symple.match(this.listeners[a][c].filters,b[0]))return this.listeners[a][c].fn.apply(this,b),"undefined"!=this.listeners[a][c].after&&this.listeners[a][c].after.apply(this,b),!0;return!1}}),Symple.Roster=Symple.Manager.extend({init:function(a){Symple.log("Symple Roster: Creating"),this._super(),this.client=a},add:function(a){if(Symple.log("Symple Roster: Adding: ",a),!(a&&a.id&&a.user&&a.group))throw"Cannot add invalid peer";this._super(a),this.client.doDispatch("addPeer",a)},remove:function(a){a=Symple.parseIDFromAddress(a)||a;var b=this._super(a);return Symple.log("Symple Roster: Removing: ",a,b),b&&this.client.doDispatch("removePeer",b),b},get:function(a){return peer=this._super(a),peer?peer:this.findOne(Symple.parseAddress(a))},update:function(a){if(a&&a.id){var b=this.get(a.id);if(b)for(var c in a)b[c]=a[c];else this.add(a)}}}),Symple.parseIDFromAddress=function(a){var b=a.split("/");return 2==b.length?b[1]:null},Symple.parseAddress=function(a){var b,c={},d=a.split("/");return d.length<2?b=a:(c.id=d[1],b=d[0]),d=b.split("@"),d.length<2?c.group=b:(c.user=d[0],c.group=d[1]),c},Symple.buildAddress=function(a,b){return(a.user?a.user+"@":"")+(a.group?a.group:b)+"/"+(a.id?a.id:"")},Symple.Message=function(a){"object"==typeof a&&this.fromJSON(a),this.type="message"},Symple.Message.prototype={fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from}},Symple.Command=function(a){"object"==typeof a&&this.fromJSON(a),this.type="command"},Symple.Command.prototype={getData:function(a){return this.data?this.data[a]:null},params:function(){return this.node.split(":")},param:function(a){return this.params()[a-1]},matches:function(a){if(xparams=a.split(":"),xparams.length>this.params().length)return!1;for(var b=0;b<xparams.length;b++)if("*"!=xparams[b]&&xparams[b]!=this.params()[b])return!1;return!0},fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from&&this.node}},Symple.Presence=function(a){"object"==typeof a&&this.fromJSON(a),this.type="presence"},Symple.Presence.prototype={fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from}},Symple.Event=function(a){"object"==typeof a&&this.fromJSON(a),this.type="event"},Symple.Event.prototype={fromJSON:function(a){for(var b in a)this[b]=a[b]},valid:function(){return this.id&&this.from&&this.name}};var Symple={filterObject:function(a,b,c){var d=[];for(var e in a)if(a.hasOwnProperty(e)){var f=a[e];if(b&&e!=b||c&&f!=c){if("object"==typeof f){var g=Symple.filterObject(f,b,c);g&&(d=d.concat(g))}}else d.push(a)}return d},deleteNested:function(a,b,c){for(var d in a){var e=a[d];b&&d!=b||c&&e!=c?"object"==typeof e&&Symple.deleteNested(e,b):delete a[d]}},countNested:function(a,b,c,d){void 0===d&&(d=0);for(var e in a)if(a.hasOwnProperty(e)){var f=a[e];b&&e!=b||c&&f!=c?"object"==typeof f&&(d=Symple.countNested(f,b,c,d)):d++}return d},traverse:function(a,b){for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];b(c,d),"object"==typeof d&&Symple.traverse(d,b)}},randomString:function(){return Math.random().toString(36).slice(2)},merge:function(a,b){for(var c in b)try{a[c]=b[c].constructor==Object?merge(a[c],b[c]):b[c]}catch(d){a[c]=b[c]}return a},extend:function(){for(var a=function(a,b){for(var c in b)hasOwnProperty.call(b,c)&&(a[c]=b[c]);return a},b=arguments[0],c=1;c<arguments.length;c++)b=a(b,arguments[c]);return b},runVendorMethod:function(a,b){for(var c,d,e=0,f=["webkit","moz","ms","o",""];e<f.length&&!a[c];){if(c=b,""==f[e]&&(c=c.substr(0,1).toLowerCase()+c.substr(1)),c=f[e]+c,d=typeof a[c],"undefined"!=d)return f=[f[e]],"function"==d?a[c]():a[c];e++}},parseISODate:function(a){var b=Date.parse(a);if(isNaN(b)){var c,d=0,e=[1,4,5,6,7,10,11];if(c=/^(\d{4}|[+\-]\d{6})(?:-(\d{2})(?:-(\d{2}))?)?(?:T(\d{2}):(\d{2})(?::(\d{2})(?:\.(\d{3}))?)?(?:(Z)|([+\-])(\d{2})(?::(\d{2}))?)?)?$/.exec(a)){for(var f,g=0;f=e[g];++g)c[f]=+c[f]||0;c[2]=(+c[2]||1)-1,c[3]=+c[3]||1,"Z"!==c[8]&&void 0!==c[9]&&(d=60*c[10]+c[11],"+"===c[9]&&(d=0-d)),b=Date.UTC(c[1],c[2],c[3],c[4],c[5]+d,c[6],c[7])}}return new Date(b)},isMobileDevice:function(){return"ontouchstart"in document.documentElement},iOSVersion:function(){return parseFloat((""+(/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))||!1},match:function(a,b){var c=!0;for(var d in a)if(!a.hasOwnProperty(d)||!b.hasOwnProperty(d)||b[d]!=a[d]){c=!1;break}return c},formatTime:function(a){function b(a){return 10>a?"0"+a:a}return b(a.getHours()).toString()+":"+b(a.getMinutes()).toString()+":"+b(a.getSeconds()).toString()+" "+b(a.getDate()).toString()+"/"+b(a.getMonth()).toString()},log:function(){"undefined"!=typeof console&&"undefined"!=typeof console.log&&console.log.apply(console,arguments)}};!function(a){var b=!1,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;a.Class=function(){},a.Class.extend=function(a){function d(){!b&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;b=!0;var f=new this;b=!1;for(var g in a)f[g]="function"==typeof a[g]&&"function"==typeof e[g]&&c.test(a[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,a[g]):a[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(Symple),Symple.Dispatcher=Symple.Class.extend({init:function(){this.listeners={}},on:function(a,b){"undefined"==typeof this.listeners[a]&&(this.listeners[a]=[]),"undefined"!=typeof b&&b.constructor==Function&&this.listeners[a].push(b)},clear:function(a,b){if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c]==b&&this.listeners[a].splice(c,1)},dispatch:function(){var a=arguments[0],b=Array.prototype.slice.call(arguments,1);if("undefined"!=typeof this.listeners[a])for(var c=0;c<this.listeners[a].length;c++)this.listeners[a][c].constructor==Function&&this.listeners[a][c].apply(this,b)}}),Symple.Manager=Symple.Class.extend({init:function(a){this.options=a||{},this.key=this.options.key||"id",this.store=[]},add:function(a){this.store.push(a)},remove:function(a){for(var b=null,c=0;c<this.store.length;c++)if(this.store[c][this.key]==a){b=this.store[c],this.store.splice(c,1);break}return b},get:function(a){for(var b=0;b<this.store.length;b++)if(this.store[b][this.key]==a)return this.store[b];return null},find:function(a){for(var b=[],c=0;c<this.store.length;c++)Symple.match(a,this.store[c])&&b.push(this.store[c]);return b},findOne:function(a){var b=this.find(a);return b.length?b[0]:void 0},last:function(){return this.store[this.store.length-1]},size:function(){return this.store.length}});var JFlashBridge={items:{},bind:function(a,b){Symple.log("JFlashBridge: Bind: ",a,b),this.items[a]=b},unbind:function(a){delete this.items[a]},call:function(){var a=this.items[arguments[0]];if(a){var b=a[arguments[1]];b?b.apply(a,Array.prototype.slice.call(arguments,2)):Symple.log("JFlashBridge: No method: ",arguments[1])}else Symple.log("JFlashBridge: No binding: ",arguments)},getSWF:function(a){return-1!=navigator.appName.indexOf("Microsoft")?window[a]:document[a]}};Symple.Media.registerEngine({id:"Flash",name:"Flash Player",formats:"MJPEG, FLV, Speex",preference:40,support:function(){return!0}()}),Symple.Player.Engine.Flash=Symple.Player.Engine.extend({init:function(a){Symple.log("SympleFlashEngine: Init"),this._super(a),this.initialized=!1,this.streamOnInit=!1,this.id="symple-player-"+Symple.randomString(6)},setup:function(){Symple.log("SympleFlashEngine: Create"),this.initialized=!1,this.player.screen.prepend('<div id="'+this.id+'">Flash version 10.0.0 or newer is required.</div>'),JFlashBridge.bind(this.id,this),swfobject.embedSWF(this.player.options.swf?this.player.options.swf:this.player.options.htmlRoot+"/symple.player.swf",this.id,"100%","100%","10.0.0",this.player.options.htmlRoot+"/playerProductInstall.swf",{},{quality:"high",wmode:"transparent",allowScriptAccess:"sameDomain",allowFullScreen:"true"},{name:this.id});var a=this;this.player.screen.mousedown(function(){a.player.screen.trigger("click")})},play:function(a){if(Symple.log("SympleFlashEngine: Play",a),this.params=a,this.initialized){if(Symple.log("SympleFlashEngine: Opening",a),this.swf().open(a),this.candidates)for(var b=0;b<this.candidates.length;b++)Symple.log("SympleFlashEngine: Add stored candidate",this.candidates[b]),this.swf().addCandidate(this.candidates[b])}else Symple.log("SympleFlashEngine: Waiting for SWF"),this.streamOnInit=!0},stop:function(){Symple.log("SympleFlashEngine: Stop"),this.initialized&&(this.swf().close(),this.setState("stopped"))},swf:function(){return JFlashBridge.getSWF(this.id)},isJSReady:function(){return Symple.log("SympleFlashEngine: JavaScript Ready: "+$.isReady),$.isReady},refresh:function(){Symple.log("SympleFlashEngine: Refresh");try{this.initialized&&this.swf().refresh()}catch(a){}},onRemoteCandidate:function(a){if(this.params&&this.params.url)throw"Cannot add candiate after explicit URL was provided.";this.initialized?(Symple.log("SympleFlashEngine: Adding remote candiate ",a),this.swf().addCandiate(a)):(Symple.log("SympleFlashEngine: Storing remote candiate ",a),this.candidates||(this.candidates=[]),this.candidates.push(a))},onSWFLoaded:function(){Symple.log("SympleFlashEngine: Loaded"),this.initialized=!0,this.streamOnInit&&this.play(this.params)},onPlayerState:function(a,b){a=a.toLowerCase(),"error"!=a||b&&0!=b.length||(b="Streaming connection to the host was lost."),Symple.log("SympleFlashEngine: On state: ",a,b,this.player.state),"none"!=a&&this.setState(a,b)},onMetadata:function(a){if(a&&a.length){for(var b="",c=0;c<a.length;++c)b+=a[c][0],b+=": ",b+=a[c][1],b+="<br>";this.player.displayStatus(b)}},onLogMessage:function(a,b){Symple.log("SympleFlashEngine: "+a+": "+b)}}),Symple.Media={engines:{},registerEngine:function(a){return Symple.log("Register media engine: ",a),a.name&&"undefined"!=typeof a.preference&&"undefined"!=typeof a.support?(this.engines[a.id]=a,!0):(Symple.log("Cannot register invalid engine: ",a),!1)},hasEngine:function(a){return"object"==typeof this.engines[a]},supportsEngine:function(a){return!(!this.hasEngine(a)||!this.engines[a].support)},supportsFormat:function(a){return!!preferredEngine(a)},compatibleEngines:function(){var a,b=[];for(var c in this.engines)a=this.engines[c],0!=a.preference&&(Symple.log("Symple Media: Supported: ",a.name,a.support),1==a.support&&b.push(a));return b.sort(function(a,b){return a.preference<b.preference?1:a.preference>b.preference?-1:void 0}),b},preferredCompatibleEngine:function(a){var b,c=this.compatibleEngines(a);return b=c.length?c[0]:null,Symple.log("Symple Media: Preferred Engine: ",b),b},getOptimalVideoResolution:function(){var a=$(window).width(),b=a>800?800:a>640?640:a>480?400:a>320?320:a>240?240:a>160?160:a>128?128:96,c=.75*b;return[b,c]},buildURL:function(a){var b,c=[],d=a.address;b=d.scheme+"://"+d.host+":"+d.port+(d.uri?d.uri:"/");for(var e in a)"address"!=e&&c.push(encodeURIComponent(e)+"="+encodeURIComponent(a[e]));return c.push("rand="+Math.random()),b+="?",b+=c.join("&")},rescaleVideo:function(a,b,c,d){var e=c/d,f=1.33;return e>f?(b=d,a=b*f):(a=c,b=a/f),[a,b]},checkCandidate:function(a,b){Symple.log("Symple Media: Checking candidate: ",a);var c;if(window.XMLHttpRequest)c=new XMLHttpRequest;else{if(!window.ActiveXObject)return void b(a,!1);c=new ActiveXObject("Microsoft.XMLHTTP")}c.onreadystatechange=function(){2==c.readyState?b&&(Symple.log("Symple Media: Candidate result: ",c.readyState,c.status),b(a,200==c.status),b=null,setTimeout(function(){c.abort()},0)):4==c.readyState&&b&&(Symple.log("Symple Media: Candidate result: ",c.readyState,c.status),b(a,!0),b=null)},c.open("GET",a,!0),c.send(null)}},Symple.Player=Symple.Class.extend({init:function(a){if(this.options=$.extend({htmlRoot:"/javascripts/symple",element:".symple-player:first",format:"MJPEG",engine:void 0,onCommand:function(){},onStateChange:function(){},template:'            <div class="symple-player">                <div class="symple-player-message"></div>                <div class="symple-player-status"></div>                <div class="symple-player-loading"></div>                <div class="symple-player-screen"></div>                <div class="symple-player-controls">                    <a class="play-btn" rel="play" href="#">Play</a>                    <a class="stop-btn" rel="stop" href="#">Stop</a>                    <a class="fullscreen-btn" rel="fullscreen" href="#">Fullscreen</a>                </div>            </div>'},a),this.element=$(this.options.element),this.element.hasClass("symple-player")||(this.element.html(this.options.template),this.element=this.element.children(".symple-player:first")),!this.element.length)throw"Player element not found";if(this.screen=this.element.find(".symple-player-screen"),!this.screen.length)throw"Player screen element not found";if(this.message=this.element.find(".symple-player-message"),!this.message.length)throw"Player message element not found";if("undefined"==typeof this.options.engine){var b=Symple.Media.preferredCompatibleEngine(this.options.format);b&&(this.options.engine=b.id)}this.bindEvents(),this.playing=!1,Symple.log(this.options.template)},setup:function(){var a=this.options.engine;if(!a)throw"Streaming engine not configured. Please set 'options.engine'";if(!Symple.Media.hasEngine(a))throw"Streaming engine not available: "+a;if("undefined"==typeof Symple.Player.Engine[a])throw"Streaming engine not found: "+a;if(!Symple.Media.supportsEngine(a))throw"Streaming engine not supported: "+a;this.engine=new Symple.Player.Engine[a](this),this.engine.setup(),this.element.addClass("engine-"+a.toLowerCase())},play:function(a){Symple.log("Symple Player: Play: ",a);try{this.engine||this.setup(),"playing"!=this.state&&(this.setState("loading"),this.engine.play(a))}catch(b){throw this.setState("error"),this.displayMessage("error",b),b}},stop:function(){Symple.log("Symple Player: Stop"),"stopped"!=this.state&&this.engine&&this.engine.stop()},destroy:function(){this.engine&&this.engine.destroy(),this.element.remove()},setState:function(a,b){Symple.log("Symple Player: Set state:",this.state,"=>",a,b),this.state!=a&&(this.state=a,this.displayStatus(null),this.playing="playing"==a,b?this.displayMessage("error"==a?"error":"info",b):this.displayMessage(null),this.element.removeClass("state-stopped state-loading state-playing state-paused state-error"),this.element.addClass("state-"+a),this.options.onStateChange(this,a,b))},displayStatus:function(a){this.element.find(".symple-player-status").html(a?a:"")},displayMessage:function(a,b){Symple.log("Symple Player: Display message:",a,b),b?this.message.html('<p class="'+a+'-message">'+b+"</p>").show():this.message.html("").hide()},bindEvents:function(){var a=this;this.element.find(".symple-player-controls a").unbind().bind("click tap",function(){return a.sendCommand(this.rel,$(this)),!1})},sendCommand:function(a,b){if(!this.options.onCommand||!this.options.onCommand(this,a,b))switch(a){case"play":this.play();break;case"stop":this.stop();break;case"fullscreen":this.toggleFullScreen()}},getButton:function(a){return this.element.find('.symple-player-controls [rel="'+a+'"]')},toggleFullScreen:function(){Symple.runVendorMethod(document,"FullScreen")||Symple.runVendorMethod(document,"IsFullScreen")?Symple.runVendorMethod(document,"CancelFullScreen"):Symple.runVendorMethod(this.element[0],"RequestFullScreen")}}),Symple.Player.Engine=Symple.Class.extend({init:function(a){this.player=a,this.fps=0,this.seq=0},support:function(){return!0},setup:function(){},destroy:function(){},play:function(a){this.params=a||{},this.params.url||"object"!=typeof a.address||(this.params.url=this.buildURL())},stop:function(){},pause:function(){},mute:function(){},setState:function(a,b){this.player.setState(a,b)},setError:function(a){Symple.log("Symple Player Engine: Error:",a),this.setState("error",a)},onRemoteCandidate:function(){Symple.log("Symple Player Engine: Remote candidates not supported.")},updateFPS:function(){if("undefined"==typeof this.prevTime&&(this.prevTime=(new Date).getTime()),this.seq>0){var a=(new Date).getTime();this.delta=this.prevTime?a-this.prevTime:0,this.fps=(1e3/this.delta).toFixed(3),this.prevTime=a}this.seq++},displayFPS:function(){this.updateFPS(),this.player.displayStatus(this.delta+" ms ("+this.fps+" fps)")},buildURL:function(){if(!this.params)throw"Streaming parameters not set";return this.params.address||(this.params.address=this.player.options.address),Symple.Media.buildURL(this.params)}}),Symple.Media.BrowserCompatabilityMsg='    <br>Download the latest version <a href="www.google.com/chrome/">Chrome</a> or     <a href="http://www.apple.com/safari/">Safari</a> to view this video stream.',Symple.Media.registerEngine({id:"MJPEG",name:"MJPEG Native",formats:"MJPEG",preference:60,defaults:{framing:"multipart"},support:function(){var a=navigator.userAgent,b=Symple.iOSVersion();return!(!a.match(/(Firefox|Chrome)/)&&!(b?6>b:a.match(/(Safari)/)))}()}),Symple.Player.Engine.MJPEG=Symple.Player.Engine.extend({init:function(a){this._super(a),this.img=null},play:function(a){if(Symple.log("MJPEG Native: Play",a),this.img)throw"Streaming already initialized";this._super(a);var b=this,c=!0;this.img=new Image,this.img.style.display="none",this.img.onload=function(){Symple.log("MJPEG Native: Success"),c?(b.img&&(b.img.style.display="inline"),b.setState("playing"),c=!1):b.displayFPS()},this.img.onerror=function(){b.setError("Streaming connection failed."+Symple.Media.BrowserCompatabilityMsg)},this.img.src=this.params.url,this.player.screen.prepend(this.img)},stop:function(){Symple.log("MJPEG Native: Stop"),this.cleanup(),this.setState("stopped")},cleanup:function(){this.img&&(this.img.style.display="none",this.img.src="#",this.img.onload=new Function,this.img.onerror=new Function,this.player.screen[0].removeChild(this.img),this.img=null)},setError:function(a){Symple.log("Symple MJPEG Engine: Error:",a),this.cleanup(),this.setState("error",a)}}),Symple.Media.registerEngine({id:"MJPEGWebSocket",name:"MJPEG WebSocket",formats:"MJPEG",preference:50,support:function(){return window.WebSocket=window.WebSocket||window.MozWebSocket,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,!(!window.WebSocket||2!==window.WebSocket.CLOSING||!window.URL)}()}),Symple.Player.Engine.MJPEGWebSocket=Symple.Player.Engine.extend({init:function(a){this._super(a),this.socket=null,this.img=null},play:function(a){if(this.active())throw"Streaming already active";this._super(a),this.createImage();var b=this,c=!0;Symple.log("MJPEG WebSocket: Play:",this.params),this.socket=new WebSocket(this.normalizeURL(this.params.url)),this.socket.onopen=function(){Symple.log("MJPEG WebSocket: Open")},this.socket.onmessage=function(a){Symple.log("MJPEG WebSocket: Message: ",a),b.active()||b.setError("Streaming failed"),c&&(b.setState("playing"),c=!1),Symple.log("MJPEG WebSocket: Frame",b,a.data);var d=window.URL.createObjectURL(a.data);b.img.onload=function(){window.URL.revokeObjectURL(d)},b.img.src=d,b.displayFPS()},this.socket.onerror=function(a){b.setError("Invalid MJPEG stream: "+a+".")}},stop:function(){Symple.log("MJPEG WebSocket: Stop"),this.cleanup(),this.setState("stopped")},active:function(){return null!==this.img&&null!==this.socket},cleanup:function(){Symple.log("MJPEG WebSocket: Cleanup"),this.img&&(this.img.style.display="none",this.img.src="#",this.img.onload=null,this.img.onerror=null,this.player.screen[0].removeChild(this.img),this.img=null),this.socket&&(Symple.log("MJPEG WebSocket: Cleanup: Socket: ",this.socket),this.socket.close(),this.socket=null)},createImage:function(){if(!this.img){this.img=new Image,this.img.style.width="100%",this.img.style.height="100%";this.img.onerror=function(a){Symple.log("MJPEG WebSocket: Image load error: ",a)},this.player.screen.append(this.img)}},normalizeURL:function(a){return a.replace(/^http/,"ws")},setError:function(a){Symple.log("MJPEG WebSocket: Error:",a),this.cleanup(),this.setState("error",a)}}),Symple.MultipartParser=Symple.Class.extend({init:function(a){this.engine=a,this.contentType=null,this.boundary=0,this.xhr.numParsed=0},process:function(a){var b=this.incrParse(a);b[0]>0&&(this.processPart(b[1]),this.xhr.numParsed+=b[0],a.length>this.xhr.numParsed&&this.processChunk())},processPart:function(a){a=a.replace(this.boundary+"\r\n","");for(var b=a.split("\r\n"),c={};/^[-a-z0-9]+:/i.test(b[0]);){var d=b.shift().split(":");c[d[0]]=d[1].trim(),this.contentType||"Content-Type"==d[0]&&(this.contentType=d[1].trim())}var e=b.join("\r\n");this.draw(e)},incrParse:function(a){if(a.length<1)return[-1];var b=a.indexOf(this.boundary);if(-1==b)return[-1];var c=a.indexOf(this.boundary,b+this.boundary.length);if(b>-1&&c>-1){var d=a.substring(b,c);return[c,d]}return[-1]}}),Symple.ChunkedParser=Symple.Class.extend({init:function(a){this.engine=a},process:function(a){for(var b,c=0,d=a.indexOf("/9j/");d>-1;)if(b=d,d=a.indexOf("/9j/",d+4),d>-1){var e=a.substr(b,d);this.engine.draw(e),c+=e.length}return c}}),Symple.Media.registerEngine({id:"MJPEGBase64MXHR",name:"MJPEG Base64 MXHR",formats:"MJPEG",defaults:{framing:"chunked",encoding:"Base64"},preference:30,support:function(){return"XMLHttpRequest"in window}()}),Symple.Player.Engine.MJPEGBase64MXHR=Symple.Player.Engine.extend({init:function(a){this._super(a),this.xhrID=0,this.xhrConn=null,this.contentType=null,this.img=null,this.errors=0},play:function(a){if(this.xhr)throw"Streaming already initialized";this._super(a),this.rotateConnection()},stop:function(){this.xhrConn&&(this.freeXHR(this.xhrConn),this.xhrConn=null),this.freeImage(this.img),this.img=null,this.player.screen.html(""),this.setState("stopped")},rotateConnection:function(){if(!this.params.url)throw"Invalid streaming URL";this.xhrID++;var a=this,b=this.createXHR();b.xhrID=this.xhrID,b.connecting=!0,b.cancelled=!1,b.onreadystatechange=function(){if(a.onReadyState.call(a,this),3==this.readyState)if(this.connecting){if(this.connecting=!1,a.xhrConn){if(a.xhrConn.xhrID==this.xhrID)throw"XHR ID mismatch";if(a.xhrConn===this)throw"XHR instance mismatch";a.xhrConn.onreadystatechange=new Function,a.xhrConn.abort(),delete a.xhrConn.responseText,a.xhrConn=null}a.xhrConn=this}else this.cancelled===!1&&this.responseText&&this.responseText.length>2097152&&(this.cancelled=!0,a.rotateConnection())},b.open("GET",this.params.url,!0),b.send(null),b=null},draw:function(a){this.img||(this.img=this.createImage(),this.player.screen.prepend(this.img)),this.img.src="data:"+this.contentType+";base64,"+a,this.displayFPS()},createXHR:function(){try{return new ActiveXObject("MSXML2.XMLHTTP.6.0")}catch(a){try{return new ActiveXObject("MSXML3.XMLHTTP")}catch(b){try{return new XMLHttpRequest}catch(c){throw new Error("Could not find supported version of XMLHttpRequest.")}}}},freeXHR:function(a){a.canceled=!0,a.abort(),a.onreadystatechange=new Function,delete a.responseText,a=null},createImage:function(a){var a=new Image;return a.self=this,a.style.zIndex=-1,a.onload=function(){Symple.log("MJPEGBase64MXHR: Onload"),"loading"==this.self.player.state&&this.self.setState("playing"),this.self.errors=0},a.onerror=function(){Symple.log("MJPEGBase64MXHR: Bad frame: ",frame.length,frame.substr(0,50),frame.substr(frame.length-50,frame.length)),this.self.errors++,5==this.self.errors&&"loading"==this.self.player.state&&this.self.setError("Streaming ended. Invalid media format.")},a},freeImage:function(a){a.onload=new Function,a.onerror=new Function,a.parentNode&&a.parentNode.removeChild(a),a=null},onReadyState:function(a){if(2==a.readyState){var b=a.getResponseHeader("Content-Type");b&&-1!=b.indexOf("multipart/")?(this.parser=new Symple.MultipartParser(this),this.parser.boundary="--"+b.split("=")[1]):this.parser=new Symple.ChunkedParser(this)}else if(3==a.readyState){isNaN(a.numParsed)&&(a.numParsed=0),this.contentType||(this.contentType=a.getResponseHeader("Content-Type")?a.getResponseHeader("Content-Type"):"image/jpeg");var c=a.responseText.length,d=a.responseText.substring(a.numParsed,c);d.length&&(a.numParsed+=this.parser.process(d))}else 4==a.readyState&&(this.onComplete(a.status),a.onreadystatechange=new Function,a=null)},onComplete:function(a){return this.player.playing?(stop(),void this.player.displayMessage("info","Streaming ended: Connection closed by peer.")):void this.setError(200==a?"Streaming connection failed: Not a multipart stream."+Symple.Media.BrowserCompatabilityMsg:"Streaming connection failed."+Symple.Media.BrowserCompatabilityMsg)}}),Symple.Media.registerEngine({id:"PseudoMJPEG",name:"Pseudo MJPEG",formats:"MJPEG, JPEG",preference:0,support:function(){return!0}()}),Symple.Player.Engine.PseudoMJPEG=Symple.Player.Engine.extend({init:function(a){this._super(a),this.lastImage=null,this.player.options.threads||(this.player.options.threads=2),$.ajaxSetup({cache:!1})},play:function(a){this._super(a),Symple.log("PseudoMJPEG: Play: ",this.params);for(var b=0;b<this.player.options.threads;++b)this.loadNext()},stop:function(){Symple.log("Symple PseudoMJPEG: stop"),this.player.playing=!1,this.lastImage&&(this.free(this.lastImage),this.lastImage=null),this.player.screen.html(""),this.setState("stopped")},loadNext:function(){var a=this,b=new Image;b.seq=this.seq,b.self=this,b.style.position="absolute",b.style.left=0,b.style.zIndex=-1,b.style.width="100%",b.style.height="100%",b.onload=function(){Symple.log("Symple PseudoMJPEG: Onload"),"loading"==a.player.state&&a.setState("playing"),a.show.call(a,this)},Symple.log("Symple PseudoMJPEG: loadNext",this.seq),this.seq<5&&(b.onerror=function(){Symple.log("Symple PseudoMJPEG: OnError"),a.free(b),a.setError("Streaming connection failed.")}),b.src=this.params.url+"&seq="+this.seq,this.player.screen.prepend(b)},show:function(a){if(Symple.log("Symple PseudoMJPEG: Show"),this.player.playing){if(this.lastImage&&this.lastImage.seq>a.seq)return this.free(a),void Symple.log("Symple PseudoMJPEG: Dropping: "+a.seq+" < "+this.lastImage.seq);a.style.zIndex=a.seq,this.lastImage&&this.free(this.lastImage),this.lastImage=a,this.displayFPS(),this.loadNext()}},free:function(a){a.parentNode.removeChild(a)},setError:function(a){Symple.log("Symple PseudoMJPEG: Error:",a),this.setState("error",a)}}),window.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,window.RTCSessionDescription=window.mozRTCSessionDescription||window.RTCSessionDescription,window.RTCIceCandidate=window.mozRTCIceCandidate||window.RTCIceCandidate,navigator.getUserMedia=navigator.mozGetUserMedia||navigator.webkitGetUserMedia,window.URL=window.webkitURL||window.URL,Symple.Media.registerEngine({id:"WebRTC",name:"WebRTC Player",formats:"VP8, Opus",preference:100,support:function(){return"undefined"!=typeof RTCPeerConnection
}()}),Symple.Player.Engine.WebRTC=Symple.Player.Engine.extend({init:function(a){Symple.log("SympleWebRTC: Init"),this._super(a),this.rtcConfig=a.options.rtcConfig||{iceServers:[{url:"stun:stun.l.google.com:19302"}]},this.rtcOptions=a.options.rtcOptions||{optional:[{DtlsSrtpKeyAgreement:!0}]},this.mediaConstraints=a.options.mediaConstraints||{}},setup:function(){Symple.log("SympleWebRTC: Setup"),this._createPeerConnection(),"undefined"==typeof this.video&&(Symple.log("SympleWebRTC: Setup: Peer video"),this.video=$("<video autoplay></video>"),this.player.screen.prepend(this.video))},destroy:function(){Symple.log("SympleWebRTC: Destroy"),this.sendLocalSDP=null,this.sendLocalCandidate=null,this.video&&(this.video[0].src="",this.video[0]=null,this.video=null),this.pc&&(this.pc.close(),this.pc=null)},play:function(a){if(Symple.log("SympleWebRTC: Play",a),a&&a.localMedia){var b=this;navigator.getUserMedia({audio:!a.disableAudio,video:!a.disableVideo},function(a){b.video[0].src=URL.createObjectURL(a),b.pc.addStream(a),b.pc.createOffer(function(a){b._onLocalSDP(a)})},function(a){b.setError("getUserMedia() Failed: "+a)})}},stop:function(){this.video&&(this.video[0].src=""),this.pc&&(this.pc.close(),this.pc=null),this.setState("stopped")},mute:function(a){a=a===!1?!1:!0,Symple.log("SympleWebRTC: Mute:",a),this.video&&this.video.prop("muted",a)},sendLocalSDP:new Function,sendLocalCandidate:new Function,onRemoteSDP:function(a){if(Symple.log("SympleWebRTC: Recieve remote SDP:",a),!a||!a.type||!a.sdp)throw"Invalid SDP data";var b=this;this.pc.setRemoteDescription(new RTCSessionDescription(a),function(){Symple.log("SympleWebRTC: SDP success")},function(a){console.error("SympleWebRTC: SDP error:",a),b.setError("Cannot parse remote SDP offer")}),"offer"==a.type&&this.pc.createAnswer(function(a){b._onLocalSDP(a)},function(){b.setError("Cannot create local SDP answer")},null)},onRemoteCandidate:function(a){if(!this.pc)throw"The peer connection is not initialized";this.pc.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:a.sdpMLineIndex,candidate:a.candidate}))},_onLocalSDP:function(a){try{this.pc.setLocalDescription(a),this.sendLocalSDP(a)}catch(b){Symple.log("Failed to send local SDP:",b)}},_createPeerConnection:function(){if(this.pc)throw"The peer connection is already initialized";Symple.log("SympleWebRTC: Creating peer connection: ",this.rtcConfig);var a=this;this.pc=new RTCPeerConnection(this.rtcConfig,this.rtcOptions),this.pc.onicecandidate=function(b){b.candidate?a.sendLocalCandidate(b.candidate):Symple.log("SympleWebRTC: Local candidate gathering complete")},this.pc.onaddstream=function(b){Symple.log("SympleWebRTC: Remote stream added:",URL.createObjectURL(b.stream)),a.setState("playing"),a.video[0].src=URL.createObjectURL(b.stream),a.video[0].play()},this.pc.onremovestream=function(b){Symple.log("SympleWebRTC: Remote stream removed:",b),a.video[0].stop()},Symple.log("SympleWebRTC: Setupd RTCPeerConnnection with config: "+JSON.stringify(this.rtcConfig))}}),Symple.Media.iceCandidateType=function(a){return-1!=a.indexOf("typ relay")?"turn":-1!=a.indexOf("typ srflx")?"stun":-1!=a.indexOf("typ host")?"host":"unknown"};